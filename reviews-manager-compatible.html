<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gesti√≥n de Rese√±as - Caba√±a Sol del Nevado</title>
  <link rel="stylesheet" href="reviews-manager.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="admin-container">
    <header class="admin-header">
      <h1><i class="fas fa-star"></i> Gesti√≥n de Rese√±as</h1>
      <p>Caba√±a Sol del Nevado - Panel de Administraci√≥n</p>
      <div class="environment-badge">
        <i class="fas fa-cog"></i> CARGANDO...
      </div>
      
      <!-- Selector de Ambiente -->
      <div class="environment-selector">
        <label for="environment-selector">Cambiar Ambiente:</label>
        <select id="environment-selector">
          <option value="local">üè† Local</option>
          <option value="staging">üß™ Staging</option>
          <option value="production">üöÄ Production</option>
        </select>
      </div>
    </header>

    <div class="admin-content">
      <!-- Panel de Estad√≠sticas -->
      <div class="stats-panel">
        <div class="stat-card">
          <i class="fas fa-users"></i>
          <div class="stat-info">
            <h3 id="total-reviews">0</h3>
            <p>Total Rese√±as</p>
          </div>
        </div>
        <div class="stat-card">
          <i class="fas fa-star"></i>
          <div class="stat-info">
            <h3 id="avg-rating">0.0</h3>
            <p>Calificaci√≥n Promedio</p>
          </div>
        </div>
        <div class="stat-card">
          <i class="fas fa-calendar-check"></i>
          <div class="stat-info">
            <h3 id="booking-reviews">0</h3>
            <p>Rese√±as Booking</p>
          </div>
        </div>
        <div class="stat-card">
          <i class="fab fa-airbnb"></i>
          <div class="stat-info">
            <h3 id="airbnb-reviews">0</h3>
            <p>Rese√±as Airbnb</p>
          </div>
        </div>
      </div>

      <!-- Formulario para Agregar/Editar Rese√±a -->
      <div class="form-section">
        <h2><i class="fas fa-plus-circle"></i> Agregar Nueva Rese√±a</h2>
        <form id="review-form" class="review-form">
          <div class="form-row">
            <div class="form-group">
              <label for="guest-name">Nombre del Hu√©sped *</label>
              <input type="text" id="guest-name" name="guestName" required>
            </div>
            <div class="form-group">
              <label for="guest-country">Pa√≠s *</label>
              <select id="guest-country" name="country" required>
                <option value="">Seleccionar pa√≠s</option>
                <option value="Chile">Chile</option>
                <option value="Argentina">Argentina</option>
                <option value="Brasil">Brasil</option>
                <option value="Per√∫">Per√∫</option>
                <option value="Estados Unidos">Estados Unidos</option>
                <option value="Canad√°">Canad√°</option>
                <option value="Espa√±a">Espa√±a</option>
                <option value="Alemania">Alemania</option>
                <option value="Francia">Francia</option>
                <option value="Reino Unido">Reino Unido</option>
                <option value="Australia">Australia</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="guest-photo">Foto del Hu√©sped</label>
              <div class="photo-upload">
                <input type="file" id="guest-photo" name="guestPhoto" accept="image/*">
                <div class="upload-preview" id="photo-preview">
                  <i class="fas fa-camera"></i>
                  <span>Haz clic para subir foto</span>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="rating">Calificaci√≥n *</label>
              <div class="rating-input" id="rating-container">
                <input type="radio" name="rating" value="5" id="star5">
                <label for="star5"><i class="fas fa-star"></i></label>
                <input type="radio" name="rating" value="4" id="star4">
                <label for="star4"><i class="fas fa-star"></i></label>
                <input type="radio" name="rating" value="3" id="star3">
                <label for="star3"><i class="fas fa-star"></i></label>
                <input type="radio" name="rating" value="2" id="star2">
                <label for="star2"><i class="fas fa-star"></i></label>
                <input type="radio" name="rating" value="1" id="star1">
                <label for="star1"><i class="fas fa-star"></i></label>
              </div>
              <div class="rating-error" id="rating-error" style="display: none; color: #dc3545; font-size: 0.9rem; margin-top: 5px;">
                ‚ö†Ô∏è Por favor selecciona una calificaci√≥n
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="review-text">Texto de la Rese√±a *</label>
            <textarea id="review-text" name="reviewText" rows="4" required placeholder="Escribe aqu√≠ la rese√±a del hu√©sped..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="platform">Plataforma *</label>
              <select id="platform" name="platform" required>
                <option value="">Seleccionar plataforma</option>
                <option value="booking">Booking.com</option>
                <option value="airbnb">Airbnb</option>
                <option value="direct">Directo</option>
              </select>
            </div>
            <div class="form-group">
              <label for="stay-date">Fecha de la Estad√≠a</label>
              <input type="date" id="stay-date" name="stayDate">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="stay-duration">Duraci√≥n de la Estad√≠a</label>
              <input type="text" id="stay-duration" name="stayDuration" placeholder="Ej: 3 noches">
            </div>
            <div class="form-group">
              <label for="guest-count">N√∫mero de Hu√©spedes</label>
              <input type="number" id="guest-count" name="guestCount" min="1" max="10">
            </div>
          </div>

          <div class="form-group">
            <label for="host-response">Respuesta del Anfitri√≥n (Opcional)</label>
            <textarea id="host-response" name="hostResponse" rows="3" placeholder="Respuesta del anfitri√≥n a la rese√±a..."></textarea>
          </div>

          <div class="form-actions">
                          <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Guardar Rese√±a
              </button>
              <button type="button" class="btn btn-secondary" onclick="testValidation()" style="margin-left: 10px;">
                <i class="fas fa-check"></i> Probar Validaci√≥n
              </button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">
              <i class="fas fa-undo"></i> Limpiar Formulario
            </button>
          </div>
        </form>
      </div>

      <!-- Lista de Rese√±as -->
      <div class="reviews-section">
        <h2><i class="fas fa-list"></i> Rese√±as Existentes</h2>
        
        <div class="filters">
          <select id="platform-filter" onchange="filterReviews()">
            <option value="all">Todas las plataformas</option>
            <option value="booking">Booking.com</option>
            <option value="airbnb">Airbnb</option>
            <option value="direct">Directo</option>
          </select>
          <select id="rating-filter" onchange="filterReviews()">
            <option value="all">Todas las calificaciones</option>
            <option value="5">5 estrellas</option>
            <option value="4">4+ estrellas</option>
            <option value="3">3+ estrellas</option>
          </select>
          <button class="btn btn-outline" onclick="exportReviews()">
            <i class="fas fa-download"></i> Exportar
          </button>
        </div>

        <div class="reviews-list" id="reviews-list">
          <!-- Las rese√±as se cargar√°n din√°micamente -->
        </div>
      </div>

      <!-- Informaci√≥n de la API -->
      <div class="api-info-section">
        <h2><i class="fas fa-info-circle"></i> Informaci√≥n de la API</h2>
        <div class="api-status">
          <div class="status-item">
            <strong>URL de la API:</strong>
            <code id="api-url">Cargando...</code>
          </div>
          <div class="status-item">
            <strong>Estado:</strong>
            <span class="status-badge status-healthy" id="api-status">üîÑ Verificando...</span>
          </div>
          <div class="status-item">
            <strong>Base de Datos:</strong>
            <span class="status-badge status-connected">‚úÖ Conectada</span>
          </div>
          <div class="status-item">
            <strong>Almacenamiento:</strong>
            <span class="status-badge status-connected">‚úÖ Conectado</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Editar Rese√±a -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Editar Rese√±a</h2>
      <form id="edit-form" class="review-form">
        <!-- Formulario de edici√≥n -->
      </form>
    </div>
  </div>

  <script>
    // Configuraci√≥n de ambientes
    const environments = {
      local: {
        name: 'Local',
        apiUrl: 'http://localhost:8787',
        database: 'local',
        storage: 'local',
        color: '#17a2b8',
        icon: 'üè†',
        description: 'Entorno de desarrollo local'
      },
      staging: {
        name: 'Staging',
        apiUrl: 'https://cabanasoldelnevado-reviews-staging.solnevadolastrancas.workers.dev',
        database: 'cabanasoldelnevado-reviews-staging',
        storage: 'cabanasoldelnevado-images-stg',
        color: '#ff6b35',
        icon: 'üß™',
        description: 'Entorno de pruebas'
      },
      production: {
        name: 'Production',
        apiUrl: 'https://cabanasoldelnevado-reviews-prod.solnevadolastrancas.workers.dev',
        database: 'cabanasoldelnevado-reviews',
        storage: 'cabanasoldelnevado-images',
        color: '#28a745',
        icon: 'üöÄ',
        description: 'Entorno de producci√≥n'
      }
    };

    // Variables globales
    let currentEnv = 'staging';
    let reviews = [];
    let currentReview = null;
    let isEditing = false;
    let currentPhoto = null;

    // Inicializar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
      init();
    });

    // Funci√≥n de inicializaci√≥n
    function init() {
      updateEnvironmentUI();
      loadReviews();
      setupEventListeners();
      updateStats();
      checkApiHealth();
    }

    // Actualizar UI seg√∫n el ambiente
    function updateEnvironmentUI() {
      const env = environments[currentEnv];
      
      // Actualizar t√≠tulo y badge
      const title = document.querySelector('.admin-header h1');
      if (title) {
        title.innerHTML = `<i class="fas fa-star"></i> Gesti√≥n de Rese√±as - ${env.name.toUpperCase()}`;
      }
      
      const badge = document.querySelector('.environment-badge');
      if (badge) {
        badge.innerHTML = `${env.icon} ${env.name.toUpperCase()}`;
        badge.style.background = env.color;
      }
      
      // Actualizar descripci√≥n
      const description = document.querySelector('.admin-header p');
      if (description) {
        description.textContent = `Caba√±a Sol del Nevado - Panel de Administraci√≥n (${env.description})`;
      }
      
      // Actualizar informaci√≥n de la API
      updateApiInfo();
    }

    // Actualizar informaci√≥n de la API
    function updateApiInfo() {
      const env = environments[currentEnv];
      
      // Actualizar URL de la API
      const apiUrlElement = document.getElementById('api-url');
      if (apiUrlElement) {
        apiUrlElement.textContent = env.apiUrl.replace('https://', '').replace('http://', '');
      }
      
      // Actualizar colores seg√∫n ambiente
      const statusBadges = document.querySelectorAll('.status-badge');
      statusBadges.forEach(badge => {
        if (badge.classList.contains('status-healthy')) {
          badge.style.background = env.color;
        }
      });
    }

    // Configurar event listeners
    function setupEventListeners() {
      // Formulario principal
      const form = document.getElementById('review-form');
      if (form) {
        form.addEventListener('submit', handleFormSubmit);
      }

      // Subida de fotos
      const photoInput = document.getElementById('guest-photo');
      if (photoInput) {
        photoInput.addEventListener('change', handlePhotoUpload);
      }

      // Selector de ambiente
      const envSelector = document.getElementById('environment-selector');
      if (envSelector) {
        envSelector.value = currentEnv;
        envSelector.addEventListener('change', switchEnvironment);
      }

      // Validaci√≥n en tiempo real
      setupRealTimeValidation();
    }

    // Configurar validaci√≥n en tiempo real
    function setupRealTimeValidation() {
      // Validar nombre cuando se escribe
      const guestNameInput = document.getElementById('guest-name');
      if (guestNameInput) {
        guestNameInput.addEventListener('input', () => {
          const value = guestNameInput.value.trim();
          if (value.length >= 2) {
            clearFieldError('guest-name');
          }
        });
      }

      // Validar pa√≠s cuando se selecciona
      const countrySelect = document.getElementById('guest-country');
      if (countrySelect) {
        countrySelect.addEventListener('change', () => {
          if (countrySelect.value) {
            clearFieldError('guest-country');
          }
        });
      }

      // Validar calificaci√≥n cuando se selecciona
      const ratingInputs = document.querySelectorAll('input[name="rating"]');
      ratingInputs.forEach(input => {
        input.addEventListener('change', () => {
          clearRatingError();
        });
      });

      // Validar texto de rese√±a cuando se escribe
      const reviewTextArea = document.getElementById('review-text');
      if (reviewTextArea) {
        reviewTextArea.addEventListener('input', () => {
          const value = reviewTextArea.value.trim();
          if (value.length >= 10) {
            clearFieldError('review-text');
          }
        });
      }

      // Validar plataforma cuando se selecciona
      const platformSelect = document.getElementById('platform');
      if (platformSelect) {
        platformSelect.addEventListener('change', () => {
          if (platformSelect.value) {
            clearFieldError('platform');
          }
        });
      }
    }

    // Cambiar ambiente
    async function switchEnvironment(event) {
      const envName = event.target.value;
      if (!environments[envName]) return;
      
      currentEnv = envName;
      updateEnvironmentUI();
      await checkApiHealth();
      await loadReviews();
      
      showNotification(`Cambiado a ambiente: ${environments[currentEnv].name}`, 'info');
    }

    // Verificar salud de la API
    async function checkApiHealth() {
      try {
        const env = environments[currentEnv];
        const response = await fetch(`${env.apiUrl}/health`);
        if (response.ok) {
          const data = await response.json();
          updateApiStatus('healthy', '‚úÖ API Saludable');
          console.log(`API ${env.name} saludable:`, data);
        } else {
          throw new Error('Health check failed');
        }
      } catch (error) {
        updateApiStatus('error', '‚ùå Error de conexi√≥n');
        console.error(`Error al verificar salud de la API ${environments[currentEnv].name}:`, error);
      }
    }

    // Actualizar estado de la API en la UI
    function updateApiStatus(status, message) {
      const statusElement = document.getElementById('api-status');
      if (statusElement) {
        statusElement.className = `status-badge status-${status}`;
        statusElement.textContent = message;
      }
    }

    // Cargar rese√±as desde la API
    async function loadReviews() {
      try {
        const env = environments[currentEnv];
        console.log(`Cargando rese√±as desde: ${env.apiUrl}/api/reviews`);
        
        const response = await fetch(`${env.apiUrl}/api/reviews`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`Rese√±as cargadas desde ${env.name}:`, data);
        
        reviews = data.reviews || [];
        renderReviewsList();
        
      } catch (error) {
        console.error(`Error al cargar rese√±as desde ${environments[currentEnv].name}:`, error);
        showNotification(`Error al cargar rese√±as desde ${environments[currentEnv].name}`, 'error');
        
        // Usar rese√±as por defecto si la API falla
        reviews = getDefaultReviews();
        renderReviewsList();
      }
    }

    // Obtener rese√±as por defecto (fallback)
    function getDefaultReviews() {
      return [
        {
          id: generateId(),
          guestName: "Guilherme",
          country: "Brasil",
          flag: "üáßüá∑",
          rating: 5.0,
          reviewText: "El propietario y el ama de llaves fueron simplemente incre√≠bles. La casa es hermosa, limpia, c√°lida, sin detalles a resaltar. Podr√≠a vivir tranquilo en este lugar. Gracias a todos.",
          platform: "booking",
          stayDate: "2024-12-15",
          stayDuration: "3 noches",
          guestCount: 4,
          hostResponse: "Muchas gracias Guilherme por tu hermosa rese√±a. Fue un placer tenerte como hu√©sped. ¬°Esperamos verte nuevamente!",
          photo: null,
          createdAt: new Date().toISOString()
        },
        {
          id: generateId(),
          guestName: "Cifuentes",
          country: "Chile",
          flag: "üá®üá±",
          rating: 5.0,
          reviewText: "Una caba√±a realmente impecable en todo sentido, muy confortable y buena respuesta del propietario a las consultas y requerimientos. Recomiendo totalmente la caba√±a!",
          platform: "airbnb",
          stayDate: "2024-12-10",
          stayDuration: "2 noches",
          guestCount: 6,
          hostResponse: null,
          photo: null,
          createdAt: new Date().toISOString()
        }
      ];
    }

    // Generar ID √∫nico
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // Manejar env√≠o del formulario
    async function handleFormSubmit(e) {
      e.preventDefault();
      console.log('Formulario enviado');
      
      // Validar campos requeridos antes de enviar
      if (!validateForm()) {
        console.log('Formulario inv√°lido, no se puede enviar');
        return;
      }
      
      const formData = new FormData(e.target);
      const reviewData = {
        guestName: formData.get('guestName'),
        country: formData.get('country'),
        flag: getCountryFlag(formData.get('country')),
        rating: parseInt(formData.get('rating')),
        reviewText: formData.get('reviewText'),
        platform: formData.get('platform'),
        stayDate: formData.get('stayDate'),
        stayDuration: formData.get('stayDuration'),
        guestCount: parseInt(formData.get('guestCount')) || 1,
        hostResponse: formData.get('hostResponse') || null,
        photoUrl: currentPhoto || null
      };

      console.log('Datos de la rese√±a:', reviewData);

      try {
        if (isEditing) {
          await updateReview(reviewData);
        } else {
          await addReview(reviewData);
        }

        resetForm();
        showNotification(`Rese√±a guardada exitosamente en ${environments[currentEnv].name}`, 'success');
        
      } catch (error) {
        console.error(`Error al guardar rese√±a en ${environments[currentEnv].name}:`, error);
        showNotification(`Error al guardar la rese√±a en ${environments[currentEnv].name}`, 'error');
      }
    }

    // Validar formulario antes de enviar
    function validateForm() {
      let isValid = true;
      
      // Limpiar todos los errores previos
      clearAllErrors();
      
      // Obtener valores
      const guestName = document.getElementById('guest-name')?.value?.trim() || '';
      const country = document.getElementById('guest-country')?.value || '';
      const rating = document.querySelector('input[name="rating"]:checked');
      const reviewText = document.getElementById('review-text')?.value?.trim() || '';
      const platform = document.getElementById('platform')?.value || '';
      
      console.log('Validando formulario:', { guestName, country, rating: rating?.value, reviewText, platform });
      
      // Validar nombre
      if (!guestName || guestName.length < 2) {
        showFieldError('guest-name', 'El nombre debe tener al menos 2 caracteres');
        isValid = false;
      }
      
      // Validar pa√≠s
      if (!country) {
        showFieldError('guest-country', 'Debes seleccionar un pa√≠s');
        isValid = false;
      }
      
      // Validar calificaci√≥n
      if (!rating) {
        showRatingError();
        isValid = false;
      }
      
      // Validar texto de rese√±a
      if (!reviewText || reviewText.length < 10) {
        showFieldError('review-text', 'La rese√±a debe tener al menos 10 caracteres');
        isValid = false;
      }
      
      // Validar plataforma
      if (!platform) {
        showFieldError('platform', 'Debes seleccionar una plataforma');
        isValid = false;
      }
      
      if (!isValid) {
        console.log('Formulario inv√°lido, errores encontrados');
        // Enfocar el primer campo con error
        focusFirstError();
      }
      
      return isValid;
    }

    // Limpiar todos los errores
    function clearAllErrors() {
      // Limpiar errores de campos
      const errorFields = document.querySelectorAll('.field-error');
      errorFields.forEach(field => field.style.display = 'none');
      
      // Limpiar clases de error
      const errorInputs = document.querySelectorAll('.error');
      errorInputs.forEach(input => input.classList.remove('error'));
      
      // Limpiar error de rating
      clearRatingError();
    }

    // Enfocar el primer campo con error
    function focusFirstError() {
      const firstErrorField = document.querySelector('.error, .rating-input.error');
      if (firstErrorField) {
        if (firstErrorField.classList.contains('rating-input')) {
          // Si es el rating, enfocar el primer radio button
          const firstRating = document.querySelector('input[name="rating"]');
          if (firstRating) firstRating.focus();
        } else {
          firstErrorField.focus();
        }
      }
    }

    // Mostrar error en campo espec√≠fico
    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      if (field) {
        // Agregar clase de error
        field.classList.add('error');
        
        // Mostrar mensaje de error
        let errorDiv = field.parentNode.querySelector('.field-error');
        if (!errorDiv) {
          errorDiv = document.createElement('div');
          errorDiv.className = 'field-error';
          errorDiv.style.cssText = 'color: #dc3545; font-size: 0.9rem; margin-top: 5px;';
          field.parentNode.appendChild(errorDiv);
        }
        errorDiv.textContent = `‚ö†Ô∏è ${message}`;
        errorDiv.style.display = 'block';
      }
    }

    // Limpiar error en campo espec√≠fico
    function clearFieldError(fieldId) {
      const field = document.getElementById(fieldId);
      if (field) {
        field.classList.remove('error');
        
        const errorDiv = field.parentNode.querySelector('.field-error');
        if (errorDiv) {
          errorDiv.style.display = 'none';
        }
      }
    }

    // Mostrar error de calificaci√≥n
    function showRatingError() {
      const errorDiv = document.getElementById('rating-error');
      if (errorDiv) {
        errorDiv.style.display = 'block';
      }
      
      // Resaltar contenedor de rating
      const container = document.getElementById('rating-container');
      if (container) {
        container.classList.add('error');
        container.style.border = '2px solid #dc3545';
        container.style.borderRadius = '8px';
        container.style.padding = '5px';
        container.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
      }
    }

    // Limpiar error de calificaci√≥n
    function clearRatingError() {
      const errorDiv = document.getElementById('rating-error');
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
      
      // Quitar resaltado del contenedor
      const container = document.getElementById('rating-container');
      if (container) {
        container.classList.remove('error');
        container.style.border = '';
        container.style.borderRadius = '';
        container.style.padding = '';
        container.style.backgroundColor = '';
      }
    }

    // Obtener bandera del pa√≠s
    function getCountryFlag(country) {
      const flags = {
        'Chile': 'üá®üá±',
        'Argentina': 'üá¶üá∑',
        'Brasil': 'üáßüá∑',
        'Per√∫': 'üáµüá™',
        'Estados Unidos': 'üá∫üá∏',
        'Canad√°': 'üá®üá¶',
        'Espa√±a': 'üá™üá∏',
        'Alemania': 'üá©üá™',
        'Francia': 'üá´üá∑',
        'Reino Unido': 'üá¨üáß',
        'Australia': 'üá¶üá∫'
      };
      return flags[country] || 'üåç';
    }

    // Agregar nueva rese√±a
    async function addReview(reviewData) {
      try {
        const env = environments[currentEnv];
        console.log(`Agregando rese√±a en ${env.name}:`, reviewData);
        
        const response = await fetch(`${env.apiUrl}/api/reviews`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(reviewData)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || 'Unknown error'}`);
        }

        const result = await response.json();
        console.log(`Rese√±a agregada exitosamente en ${env.name}:`, result);
        
        reviews.unshift(result.review);
        renderReviewsList();
        updateStats();
        
      } catch (error) {
        console.error(`Error al agregar rese√±a en ${environments[currentEnv].name}:`, error);
        throw error;
      }
    }

    // Actualizar rese√±a existente
    async function updateReview(reviewData) {
      try {
        const env = environments[currentEnv];
        console.log(`Actualizando rese√±a en ${env.name}:`, reviewData);
        
        const response = await fetch(`${env.apiUrl}/api/reviews/${currentReview.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(reviewData)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || 'Unknown error'}`);
        }

        const result = await response.json();
        console.log(`Rese√±a actualizada exitosamente en ${env.name}:`, result);
        
        const index = reviews.findIndex(r => r.id === currentReview.id);
        if (index !== -1) {
          reviews[index] = result.review;
          renderReviewsList();
          updateStats();
        }
        
      } catch (error) {
        console.error(`Error al actualizar rese√±a en ${environments[currentEnv].name}:`, error);
        throw error;
      }
    }

    // Eliminar rese√±a
    async function deleteReview(id) {
      if (confirm(`¬øEst√°s seguro de que quieres eliminar esta rese√±a en ${environments[currentEnv].name}?`)) {
        try {
          const env = environments[currentEnv];
          console.log(`Eliminando rese√±a en ${env.name}:`, id);
          
          const response = await fetch(`${env.apiUrl}/api/reviews/${id}`, {
            method: 'DELETE'
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || 'Unknown error'}`);
          }

          console.log(`Rese√±a eliminada exitosamente en ${env.name}`);
          
          reviews = reviews.filter(r => r.id !== id);
          renderReviewsList();
          updateStats();
          showNotification(`Rese√±a eliminada exitosamente en ${env.name}`, 'success');
          
        } catch (error) {
          console.error(`Error al eliminar rese√±a en ${environments[currentEnv].name}:`, error);
          showNotification(`Error al eliminar la rese√±a en ${environments[currentEnv].name}`, 'error');
        }
      }
    }

    // Renderizar lista de rese√±as
    function renderReviewsList() {
      const container = document.getElementById('reviews-list');
      if (!container) return;

      container.innerHTML = '';
      
      reviews.forEach(review => {
        const reviewElement = createReviewElement(review);
        container.appendChild(reviewElement);
      });
    }

    // Crear elemento de rese√±a
    function createReviewElement(review) {
      const div = document.createElement('div');
      div.className = 'review-item';
      
      const platformClass = `review-platform ${review.platform}`;
      const platformText = review.platform === 'booking' ? 'Booking.com' : 
                          review.platform === 'airbnb' ? 'Airbnb' : 'Directo';

      div.innerHTML = `
        <div class="review-header">
          <div class="review-info">
            ${review.photoUrl ? 
              `<img src="${review.photoUrl}" alt="${review.guestName}" class="review-photo">` :
              `<div class="review-photo">${review.guestName.charAt(0)}</div>`
            }
            <div class="review-details">
              <h4>${review.guestName}</h4>
              <div class="review-meta">
                ${review.flag} ${review.country} ‚Ä¢ ${review.stayDate ? new Date(review.stayDate).toLocaleDateString('es-CL') : 'Fecha no especificada'}
              </div>
            </div>
          </div>
          <div class="review-rating">
            <div class="review-stars">
              ${generateStarsHTML(review.rating)}
            </div>
            <span class="${platformClass}">${platformText}</span>
          </div>
        </div>
        
        <div class="review-text">"${review.reviewText}"</div>
        
        ${review.hostResponse ? `
          <div class="host-response">
            <strong>Respuesta del anfitri√≥n:</strong> "${review.hostResponse}"
          </div>
        ` : ''}
        
        <div class="review-actions">
          <button class="btn btn-outline" onclick="editReview('${review.id}')">
            <i class="fas fa-edit"></i> Editar
          </button>
          <button class="btn btn-danger" onclick="deleteReview('${review.id}')">
            <i class="fas fa-trash"></i> Eliminar
          </button>
        </div>
      `;
      
      return div;
    }

    // Generar HTML de estrellas
    function generateStarsHTML(rating) {
      let stars = '';
      for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
          stars += '<i class="fas fa-star"></i>';
        } else {
          stars += '<i class="far fa-star"></i>';
        }
      }
      return stars;
    }

    // Editar rese√±a
    function editReview(id) {
      const review = reviews.find(r => r.id === id);
      if (!review) return;

      currentReview = review;
      isEditing = true;
      currentPhoto = review.photoUrl;
      
      populateForm(review);
      showNotification(`Modo edici√≥n activado en ${environments[currentEnv].name}`, 'info');
    }

    // Poblar formulario con datos
    function populateForm(review) {
      document.getElementById('guest-name').value = review.guestName;
      document.getElementById('guest-country').value = review.country;
      document.getElementById('rating').value = review.rating;
      document.getElementById('review-text').value = review.reviewText;
      document.getElementById('platform').value = review.platform;
      document.getElementById('stay-date').value = review.stayDate || '';
      document.getElementById('stay-duration').value = review.stayDuration || '';
      document.getElementById('guest-count').value = review.guestCount || '';
      document.getElementById('host-response').value = review.hostResponse || '';

      // Actualizar preview de foto
      if (review.photoUrl) {
        updatePhotoPreview(review.photoUrl);
      }

      // Cambiar texto del bot√≥n
      const submitBtn = document.querySelector('#review-form .btn-primary');
      if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar Rese√±a';
      }
    }

    // Manejar subida de foto
    function handlePhotoUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        showNotification('Por favor selecciona un archivo de imagen', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        currentPhoto = e.target.result;
        updatePhotoPreview(e.target.result);
      };
      reader.readAsDataURL(file);
    }

    // Actualizar preview de foto
    function updatePhotoPreview(photoData) {
      const preview = document.getElementById('photo-preview');
      if (!preview) return;

      preview.innerHTML = `<img src="${photoData}" alt="Preview">`;
      preview.classList.add('has-image');
    }

    // Resetear formulario
    function resetForm() {
      document.getElementById('review-form').reset();
      document.getElementById('photo-preview').innerHTML = `
        <i class="fas fa-camera"></i>
        <span>Haz clic para subir foto</span>
      `;
      document.getElementById('photo-preview').classList.remove('has-image');
      
      currentPhoto = null;
      currentReview = null;
      isEditing = false;

      // Restaurar texto del bot√≥n
      const submitBtn = document.querySelector('#review-form .btn-primary');
      if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Rese√±a';
      }
    }

    // Actualizar estad√≠sticas
    function updateStats() {
      const total = reviews.length;
      const avgRating = total > 0 ? 
        (reviews.reduce((sum, r) => sum + r.rating, 0) / total).toFixed(1) : '0.0';
      const bookingCount = reviews.filter(r => r.platform === 'booking').length;
      const airbnbCount = reviews.filter(r => r.platform === 'airbnb').length;

      document.getElementById('total-reviews').textContent = total;
      document.getElementById('avg-rating').textContent = avgRating;
      document.getElementById('booking-reviews').textContent = bookingCount;
      document.getElementById('airbnb-reviews').textContent = airbnbCount;
    }

    // Filtrar rese√±as
    function filterReviews() {
      const platformFilter = document.getElementById('platform-filter').value;
      const ratingFilter = document.getElementById('rating-filter').value;

      let filtered = [...reviews];

      if (platformFilter !== 'all') {
        filtered = filtered.filter(r => r.platform === platformFilter);
      }

      if (ratingFilter !== 'all') {
        const minRating = parseInt(ratingFilter);
        filtered = filtered.filter(r => r.rating >= minRating);
      }

      renderFilteredReviews(filtered);
    }

    // Renderizar rese√±as filtradas
    function renderFilteredReviews(filteredReviews) {
      const container = document.getElementById('reviews-list');
      if (!container) return;

      container.innerHTML = '';
      
      filteredReviews.forEach(review => {
        const reviewElement = createReviewElement(review);
        container.appendChild(reviewElement);
      });
    }

    // Exportar rese√±as
    function exportReviews() {
      const dataStr = JSON.stringify(reviews, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `rese√±as-caba√±a-sol-del-nevado-${environments[currentEnv].name}-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      showNotification(`Rese√±as exportadas desde ${environments[currentEnv].name}`, 'success');
    }

    // Mostrar notificaci√≥n
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Funciones globales para el HTML
    // Funci√≥n de prueba de validaci√≥n
    function testValidation() {
      console.log('Probando validaci√≥n del formulario...');
      const isValid = validateForm();
      if (isValid) {
        showNotification('‚úÖ Formulario v√°lido - todos los campos est√°n correctos', 'success');
      } else {
        showNotification('‚ùå Formulario inv√°lido - revisa los campos marcados', 'error');
      }
    }

    // Global functions for HTML
    window.resetForm = resetForm;
    window.filterReviews = filterReviews;
    window.exportReviews = exportReviews;
    window.editReview = editReview;
    window.deleteReview = deleteReview;
    window.testValidation = testValidation;
  </script>
</body>
</html> 